+++
title = "Опыт Eurobot: Деплой Docker образов на роботов в локальной сети"
date = "2023-09-01"
draft = true

[taxonomies]
tags = ["docker", "ROS", "robotics", "eurobot", "skoltech"]
+++

Продолжая серию постов про Eurobot, рассказываю про следующую деталь нашей инфраструктуры — доставку Docker образов до роботов в обход интернета и удаленных Docker Registry.

[В предыдущем посте](/posts/eurobot-experience-docker-with-ros/) я рассказал о том, как мы собирали Docker образы и как контейнеры запускались на роботах. В этот раз расскажу, как эти самые образы по Wi-Fi доставлялись с машин разработчиков на роботов.

# Мотивация

Во время подготовки к соревнованиям мы использовали как классический подход доставки образов, через Docker Hub, так и эзотерический — по локальной сети. 

Первый способ мы использовали в основном, загружая в Docker Hub стабильные образы, собранные из ветки master на CI в нашем репозитории. Мы точно знали что в публичном репозитории находятся рабочие образы и иногда откатывались к ним.

По локальной сети же мы деплоили в 99% случаев, находясь физически в лабе и отлаживая роботов вечерами после пар.

Таким образом, заливать образы минуя интернет мы хотели по двум причинам: 
1. Это тупо быстрее и удобнее.
1. На соревнованиях, куда мы приедем, может не быть интернета или он может быть нестабилен.

# Самое простое решение
<!-- Тут рассказать про первое решение до которого я додумался, экспорт docker образа в tar архив и его отправка -->

Первое решение, которое мне пришло в голову, [пришло в голову кому-то еще до меня](https://stackoverflow.com/questions/23935141/how-to-copy-docker-images-from-one-host-to-another-without-using-a-repository). Заключалось решение в следующем:

1. Собираем Docker образ.
2. Экспортируем образ в tar архив.
3. Отправляем tar архив при помощи `rsync` или `scp` на робота.
4. На роботе импортируем tar архив обратно в образ.

Решение железное и супер понятное, но во всем остальном оно ужасно:

- Вы тратите время не только на сборку образа, но и на его экспорт. Экспорт ROS образов у нас занимал 20-30 секунд.
- Нельзя отправить только изменившиеся слои образа, придется каждый раз отправлять ВЕСЬ образ.
- Образы с ROS весят больше гигабайта, и даже архивирование их не спасает. Передача таких тяжелых образов сама по себе будет съедать пару минут времени (я проверял).

Я реализовал этот способ, понял что он работает ужасно долго и для нас он не подходит. Поэтому тратить буквы на него не буду, сразу перейду к объяснению финального решения.

# Самое сложное решение
<!-- Тут рассказать сразу про суть текущего решения -->

## Шаг 0: Предварительная настройка
### Настраиваем SSH-ключи
<!-- Про SSH ключи и почему они нужны -->

### Docker BuildKit и Insecure Registry
<!-- Про то как настроить BuildKit и разрешить пушить в localhost:5000 -->

## Шаг 1: Поднимаем Docker Registry на роботе
<!-- Объяснить, почему insecure registry на самом деле secure благодаря SSH -->

## Шаг 2: Поднимаем SSH туннель между роботом и вашим компьютером

## Шаг 3: Пушим образ в Docker Registry на роботе

# Мы это автоматизировали

# Мои мысли на тему и итоги
