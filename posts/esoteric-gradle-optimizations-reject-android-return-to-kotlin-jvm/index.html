<!doctype html><html dir=auto lang=en><head><meta charset=utf-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><meta content="index, follow" name=robots><meta content=mmSUCWwptqJJuCzIwQO7JyFJ4dbxkrHO92nV7PBwRIg name=google-site-verification><title>Gradle заставляет избавляться от Android-модулей</title><meta content="android, development, tech, robotics" name=keywords><meta name=description><meta content="Anton Kolomeytsev" name=author><link href=https://tonykolomeytsev.github.io/posts/esoteric-gradle-optimizations-reject-android-return-to-kotlin-jvm/ rel=canonical><link href=https://tonykolomeytsev.github.io/css/includes/scroll-bar.css rel=stylesheet><link href=https://tonykolomeytsev.github.io/css/styles.css rel=stylesheet><link href=https://tonykolomeytsev.github.io/css/override.css rel=stylesheet><link href=https://tonykolomeytsev.github.io/atom.xml rel=alternate title=RSS type=application/atom+xml><noscript><style>#theme-toggle,.top-link{display:none}</style> <style>@media (prefers-color-scheme:dark){:root {--theme:#1d1e20;--entry:#2e2e33;--primary:#dadadb;--secondary:#9b9c9d;--tertiary:#414244;--content:#c4c4c5;--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark):-webkit-scrollbar-track {background:0 0}.list:not(.dark):-webkit-scrollbar-thumb {border:var(--theme)}}</style></noscript><body id=top><script>if(localStorage.getItem("pref-theme")==="dark"){document.body.classList.add('dark')}else if(localStorage.getItem("pref-theme")==="light"){document.body.classList.remove('dark')}else if(window.matchMedia('(prefers-color-scheme: dark)').matches){document.body.classList.add('dark')}</script><header class=header><nav class=nav><div class=logo><a title="Kekmech (Alt + H)" accesskey=h href=https://tonykolomeytsev.github.io> Kekmech </a><div class=logo-switches><button title="(Alt + T)" accesskey=t id=theme-toggle><svg viewbox="0 0 24 24" fill=none height=18 id=moon stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg> <svg viewbox="0 0 24 24" fill=none height=18 id=sun stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><circle cx=12 cy=12 r=5></circle><line x1=12 x2=12 y1=1 y2=3></line><line x1=12 x2=12 y1=21 y2=23></line><line x1=4.22 x2=5.64 y1=4.22 y2=5.64></line><line x1=18.36 x2=19.78 y1=18.36 y2=19.78></line><line x1=1 x2=3 y1=12 y2=12></line><line x1=21 x2=23 y1=12 y2=12></line><line x1=4.22 x2=5.64 y1=19.78 y2=18.36></line><line x1=18.36 x2=19.78 y1=5.64 y2=4.22></line></svg></button><ul class=lang-switch><li></ul></div></div><ul id=menu><li><a href=https://tonykolomeytsev.github.io/archive title=Archive> <span>Archive</span> </a><li><a href=https://tonykolomeytsev.github.io/tags title=Tags> <span>Tags</span> </a></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://tonykolomeytsev.github.io>Home</a> »  <a href=https://tonykolomeytsev.github.io/posts/>Posts</a> »  <a href=https://tonykolomeytsev.github.io/posts/esoteric-gradle-optimizations-reject-android-return-to-kotlin-jvm/>Gradle заставляет избавляться от Android-модулей</a></div><h1 class=post-title>Gradle заставляет избавляться от Android-модулей</h1><div class=post-meta><span title="2024-08-11 00:00:00 +0000">2024-08-11</span> · 10 min · 1927 words · Anton Kolomeytsev  | <a rel="noopener noreferrer" href=https://github.com/tonykolomeytsev/tonykolomeytsev.github.io/tree/master/content/posts/2024-08-02_esoteric_gradle_optimizations_reject_android_return_to_kotlin_jvm/index.md target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary title="(Alt + C)" accesskey=c><span class=details>Table of Contents</span></summary> <div class=inner><ul><li><a aria-label=Проблема href=#problema>Проблема</a><li><a aria-label=Решение href=#reshenie>Решение</a> <ul><li><a aria-label="Избавляемся от AGP в модулях" href=#izbavliaemsia-ot-agp-v-moduliakh>Избавляемся от AGP в модулях</a> <ul><li><a aria-label="Избавляемся чуть-чуть (android-jar)" href=#izbavliaemsia-chut-chut-android-jar>Избавляемся чуть-чуть (android-jar)</a><li><a aria-label="Избавляемся полностью жестб (aar-to-jar)" href=#izbavliaemsia-polnost-iu-zhestb-aar-to-jar>Избавляемся полностью жестб (aar-to-jar)</a></ul></ul><li><a aria-label="О чем стоит помнить" href=#o-chem-stoit-pomnit>О чем стоит помнить</a> <ul><li><a aria-label="Может упасть в рантайме" href=#mozhet-upast-v-rantaime>Может упасть в рантайме</a><li><a aria-label="Странный набор конфигураций" href=#strannyi-nabor-konfiguratsii>Странный набор конфигураций</a><li><a aria-label="Погибает android lint" href=#pogibaet-android-lint>Погибает android lint</a></ul><li><a aria-label=Итоги href=#itogi>Итоги</a></ul></div></details></div><div class=post-content><p>Ты уже оптимизировал билд кэши на CI, но время прогонов в МРах неуклонно переваливает за 10 минут? Не хочешь лезть в импакт анализ? Долгий синк проекта в студии?</p><center> <img src=no-bitches.jpeg width=90%> </center><p><del>Да и хуй с ним!</del><p>Еще остались способы уменьшить потребление памяти во время синка/сборки и ускорить билд.<h1 id=problema>Проблема<a aria-hidden=true class=anchor hidden href=#problema>#</a></h1><p>Android Gradle Plugin это тяжелая штука. Модуль с подключенным AGP (например с <code>com.android.library</code>) конфигурируется в два раза дольше чем обычный jvm модуль java/kotlin. В момент конфигурации android-модуля потребляется в два раза больше оперативной памяти. У модуля с AGP больше тасок, больше вес output артефактов, больше триггеров для инвалидации билд-кэша.<p>В крупных проектах, когда у нас есть возможность использовать модули без AGP, мы должны это делать ради времени билда и конфигурации.<p>К сожалению в 90% случаев мы не можем оставить модуль обычным JVM модулем из-за того что он ссылается на какие-то сущности из Android SDK или библиотеки, распространяемые в виде AAR артефактов.<h1 id=reshenie>Решение<a aria-hidden=true class=anchor hidden href=#reshenie>#</a></h1><blockquote><p>Решение придумано не мной. Спасибо за первоисточник Степану Гончарову и его плагинам <a href=https://github.com/stepango/android-jar>android-jar</a> и <a href=https://github.com/stepango/aar2jar>aar2jar</a>.</blockquote><p>TLDR; Решение в том чтобы разрешить JVM модулям зависеть от Android SDK и AAR, при этом не подключая AGP.<h2 id=izbavliaemsia-ot-agp-v-moduliakh>Избавляемся от AGP в модулях<a aria-hidden=true class=anchor hidden href=#izbavliaemsia-ot-agp-v-moduliakh>#</a></h2><p>Путь отказа от AGP состоит из двух шагов, которые впервые в публичном поле <a href="https://www.youtube.com/watch?v=Yft6h7JkWo0">озвучил Степан Гончаров в своем докладе</a>. У него даже остался исходный код на GitHub, который к сожалению уже не работает на новых версиях Gradle.<h3 id=izbavliaemsia-chut-chut-android-jar>Избавляемся чуть-чуть (android-jar)<a aria-hidden=true class=anchor hidden href=#izbavliaemsia-chut-chut-android-jar>#</a></h3><blockquote><p>Первоисточник: <a href=https://github.com/stepango/android-jar>https://github.com/stepango/android-jar</a></blockquote><p>Первым делом мы можем избавиться от AGP в тех модулях, которые каким-либо образом зависят от классов чистого Android, от содержимого пакетов <code>android.*</code>.<p>Например, часто встречается зависимость от класса <code>android.content.Context</code>.<p>AGP под капотом подключает к модулю <code>android.jar</code> - API от той версии Android под которую ты разрабатываешь (target sdk). Этот JAR не вшивается в твое приложение, он используется только на этапе сборки. Чтобы провалидировать все вызовы API Android из твоего кода, и чтобы в IDE автокомплит работал. По-умному говорят что <code>android.jar</code> входит в compile classpath, но не входит в runtime classpath. Подробнее об этом можно почитать <a href=https://techblog.bozho.net/runtime-classpath-vs-compile-time-classpath/>тут</a>. Когда приложение попадает на устройство или эмулятор, в рантайме оно уже <a href=https://stackoverflow.com/questions/50283073/what-is-android-jar-what-does-it-include>пользуется реальным android.jar</a>.<blockquote><p>compileClasspath можно воспринимать как аналог заголовочных (.h) файлов в Си/С++. Им не обязательно нести реализацию. Они нужны в первую очередь для того, чтобы дать нам API внешних библиотек.</blockquote><p>Фишка в том что никто не мешает нам подключить к JVM модулю <code>android.jar</code> самостоятельно, при этом избежав подключения всего AGP. В Gradle для этого есть конфигурация <code>compileOnly</code>:<pre class=language-groovy data-lang=groovy style=background:#2b303b;color:#6c7079><code class=language-groovy data-lang=groovy><span style=font-style:italic;color:#5f697a>// build.gradle
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>dependencies {
</span><span style=color:#abb2bf>    compileOnly(androidJar)
</span><span style=color:#abb2bf>}
</span></code></pre><p>Но откуда в контексте билдскрипта возьмется <code>androidJar</code>? Мы его туда сами добавим. Причем сделаем это так чтобы работало и в скриптах Groovy, и в KTS (осуждаю).<h4 id=opredeliaem-raspolozhenie-android-jar>Определяем расположение <code>android.jar</code><a aria-hidden=true class=anchor hidden href=#opredeliaem-raspolozhenie-android-jar>#</a></h4><p>Поиск нужного нам файла будет происходить на этапе конфигурации корневого проекта. Искать можно с помощью вот такого класса:<pre class=language-kotlin data-lang=kotlin style=background:#2b303b;color:#6c7079><code class=language-kotlin data-lang=kotlin><span style=color:#cd74e8>private class </span><span style=color:#f0c678>AndroidJarFinder</span><span style=color:#abb2bf>(</span><span style=color:#cd74e8>private val </span><span style=color:#adb7c9>project:</span><span style=color:#abb2bf> Project) {
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>fun </span><span style=color:#5cb3fa>find</span><span style=color:#abb2bf>(</span><span style=color:#adb7c9>compileSdk: </span><span style=color:#cd74e8>Int</span><span style=color:#abb2bf>)</span><span style=color:#adb7c9>:</span><span style=color:#abb2bf> ConfigurableFileCollection </span><span style=color:#adb7c9>=
</span><span style=color:#abb2bf>        project</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>files(</span><span style=color:#9acc76>"</span><span style=color:#eb6772>${findSdkLocation()}</span><span style=color:#9acc76>/platforms/android-</span><span style=color:#eb6772>${compileSdk}</span><span style=color:#9acc76>/android.jar"</span><span style=color:#abb2bf>)
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>private fun </span><span style=color:#5cb3fa>findSdkLocation</span><span style=color:#abb2bf>()</span><span style=color:#adb7c9>:</span><span style=color:#abb2bf> File {
</span><span style=color:#abb2bf>        </span><span style=color:#cd74e8>val </span><span style=color:#abb2bf>localProperties </span><span style=color:#adb7c9>=</span><span style=color:#abb2bf> File(project</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>rootDir, </span><span style=color:#9acc76>"local.properties"</span><span style=color:#abb2bf>)</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>takeIf { it</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>exists() }
</span><span style=color:#abb2bf>        </span><span style=color:#cd74e8>return</span><span style=color:#abb2bf> localProperties</span><span style=color:#adb7c9>?.</span><span style=color:#abb2bf>let(</span><span style=color:#adb7c9>::</span><span style=color:#abb2bf>getSdkDirFromLocalProperties)
</span><span style=color:#abb2bf>            </span><span style=color:#adb7c9>?:</span><span style=color:#abb2bf> getSdkDirFromEnvVariable()
</span><span style=color:#abb2bf>            </span><span style=color:#adb7c9>?: </span><span style=color:#cd74e8>throw</span><span style=color:#abb2bf> RuntimeException(
</span><span style=color:#abb2bf>                </span><span style=color:#9acc76>"The Android SDK location could not be found in following locations:" </span><span style=color:#adb7c9>+
</span><span style=color:#abb2bf>                        </span><span style=color:#9acc76>"- Absolute path `sdk.dir` in `local.properties` file</span><span style=color:#5ebfcc>\n</span><span style=color:#9acc76>" </span><span style=color:#adb7c9>+
</span><span style=color:#abb2bf>                        </span><span style=color:#9acc76>"- Relative path `android.dir` in `local.properties` file</span><span style=color:#5ebfcc>\n</span><span style=color:#9acc76>" </span><span style=color:#adb7c9>+
</span><span style=color:#abb2bf>                        </span><span style=color:#9acc76>"- `ANDROID_HOME` environment variable</span><span style=color:#5ebfcc>\n</span><span style=color:#9acc76>" </span><span style=color:#adb7c9>+
</span><span style=color:#abb2bf>                        </span><span style=color:#9acc76>"- System property `android.home`"
</span><span style=color:#abb2bf>            )
</span><span style=color:#abb2bf>    }
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>private fun </span><span style=color:#5cb3fa>getSdkDirFromLocalProperties</span><span style=color:#abb2bf>(</span><span style=color:#adb7c9>localProperties:</span><span style=color:#abb2bf> File)</span><span style=color:#adb7c9>:</span><span style=color:#abb2bf> File? {
</span><span style=color:#abb2bf>        </span><span style=color:#cd74e8>val </span><span style=color:#abb2bf>properties </span><span style=color:#adb7c9>=</span><span style=color:#abb2bf> Properties()
</span><span style=color:#abb2bf>        FileInputStream(localProperties)</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>use(properties</span><span style=color:#adb7c9>::</span><span style=color:#abb2bf>load)
</span><span style=color:#abb2bf>        </span><span style=font-style:italic;color:#5f697a>// `sdk.dir` is for absolute path, `android.dir` is for relative
</span><span style=color:#abb2bf>        </span><span style=color:#cd74e8>return</span><span style=color:#abb2bf> properties</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>getProperty(</span><span style=color:#9acc76>"sdk.dir"</span><span style=color:#abb2bf>)</span><span style=color:#adb7c9>?.</span><span style=color:#abb2bf>let(</span><span style=color:#adb7c9>::</span><span style=color:#abb2bf>File)
</span><span style=color:#abb2bf>            </span><span style=color:#adb7c9>?:</span><span style=color:#abb2bf> properties</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>getProperty(</span><span style=color:#9acc76>"android.dir"</span><span style=color:#abb2bf>)</span><span style=color:#adb7c9>?.</span><span style=color:#abb2bf>let { File(project</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>rootDir, it) }
</span><span style=color:#abb2bf>    }
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>private fun </span><span style=color:#5cb3fa>getSdkDirFromEnvVariable</span><span style=color:#abb2bf>()</span><span style=color:#adb7c9>:</span><span style=color:#abb2bf> File? {
</span><span style=color:#abb2bf>        </span><span style=color:#cd74e8>return</span><span style=color:#abb2bf> System</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>getenv(</span><span style=color:#9acc76>"ANDROID_HOME"</span><span style=color:#abb2bf>)</span><span style=color:#adb7c9>?.</span><span style=color:#abb2bf>let(</span><span style=color:#adb7c9>::</span><span style=color:#abb2bf>File)
</span><span style=color:#abb2bf>            </span><span style=color:#adb7c9>?:</span><span style=color:#abb2bf> System</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>getProperty(</span><span style=color:#9acc76>"android.home"</span><span style=color:#abb2bf>)</span><span style=color:#adb7c9>?.</span><span style=color:#abb2bf>let(</span><span style=color:#adb7c9>::</span><span style=color:#abb2bf>File)
</span><span style=color:#abb2bf>    }
</span><span style=color:#abb2bf>}
</span></code></pre><p>Ищем путь до установленного в систему android sdk в 4 местах:<ul><li>Свойство <code>sdk.dir</code> в <code>local.properties</code>.<li>Свойство <code>android.dir</code> в <code>local.properties</code> — обычно тут указывается путь до Android SDK установленный в директорию проекта.<li>Переменная окружения <code>ANDROID_HOME</code>.<li>Java System property <code>android.home</code>.</ul><p>К корневому проекту должен быть подключен какой-нибудь Convention-плагин, который вызовет у себя <code>rememberAndroidJar</code>:<pre class=language-kotlin data-lang=kotlin style=background:#2b303b;color:#6c7079><code class=language-kotlin data-lang=kotlin><span style=color:#cd74e8>private const val </span><span style=color:#abb2bf>AndroidJarLocationKey </span><span style=color:#adb7c9>= </span><span style=color:#9acc76>"EXAMPLE_INTERNAL__ANDROID_JAR_LOCATION"
</span><span style=color:#abb2bf>
</span><span style=color:#cd74e8>class </span><span style=color:#f0c678>AndroidJarFinderConventionPlugin </span><span style=color:#adb7c9>: </span><span style=color:#9acc76>Plugin</span><span style=color:#abb2bf><</span><span style=color:#9acc76>Project</span><span style=color:#abb2bf>> {
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>override fun </span><span style=color:#5cb3fa>apply</span><span style=color:#abb2bf>(</span><span style=color:#adb7c9>target:</span><span style=color:#abb2bf> Project) {
</span><span style=color:#abb2bf>        </span><span style=color:#adb7c9>assert</span><span style=color:#abb2bf>(target </span><span style=color:#adb7c9>==</span><span style=color:#abb2bf> target</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>rootProject) {
</span><span style=color:#abb2bf>            </span><span style=color:#9acc76>"Plugin 'jar.finder' can be applied only to root project"
</span><span style=color:#abb2bf>        }
</span><span style=color:#abb2bf>        target</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>rememberAndroidJar()
</span><span style=color:#abb2bf>    }
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    </span><span style=font-style:italic;color:#5f697a>/** В `ext` корневого проекта кладем найденный `android.jar` */
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>internal fun</span><span style=color:#abb2bf> Project.</span><span style=color:#5cb3fa>rememberAndroidJar</span><span style=color:#abb2bf>() {
</span><span style=color:#abb2bf>        </span><span style=color:#cd74e8>val </span><span style=color:#abb2bf>targetSdk </span><span style=color:#adb7c9>= </span><span style=color:#db9d63>35 </span><span style=font-style:italic;color:#5f697a>// сами придумайте откуда его брать
</span><span style=color:#abb2bf>        </span><span style=color:#cd74e8>val </span><span style=color:#abb2bf>androidJarFinder </span><span style=color:#adb7c9>=</span><span style=color:#abb2bf> AndroidJarFinder(</span><span style=color:#db9d63>this</span><span style=color:#abb2bf>)
</span><span style=color:#abb2bf>        </span><span style=color:#cd74e8>val </span><span style=color:#abb2bf>androidJar </span><span style=color:#adb7c9>=</span><span style=color:#abb2bf> androidJarFinder</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>find(targetSdk)
</span><span style=color:#abb2bf>        extensions</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>extraProperties[AndroidJarLocationKey] </span><span style=color:#adb7c9>=</span><span style=color:#abb2bf> androidJar
</span><span style=color:#abb2bf>    }
</span><span style=color:#abb2bf>}
</span><span style=color:#abb2bf>
</span></code></pre><p>Конфигурация корневого проекта всегда происходит до конфигурации дочерних проектов (сабмодулей). Даже если включена фича <a href=https://docs.gradle.org/current/userguide/multi_project_configuration_and_execution.html>Configure On Demand</a>. Поэтому на этапе конфигурации дочерних модулей мы можем пользоваться результатами вычислений в root project:</p><img src=configuration-sequence.svg width=100%><h4 id=dostup-k-androidjar-iz-dochernikh-modulei>Доступ к <code>androidJar</code> из дочерних модулей<a aria-hidden=true class=anchor hidden href=#dostup-k-androidjar-iz-dochernikh-modulei>#</a></h4><p>Gradle позволяет добавлять в контекст скриптов расширения(extensions). Расширения могут быть любым объектом, поэтому мы создадим расширение с именем <code>androidJar</code> и запихаем внутрь него <code>ConfigurableFileCollection</code>, который уже вычислен на этапе конфигурации корневого модуля. Тогда и на Groovy, и на KTS мы сможем указывать его в качестве зависимости.<pre class=language-kotlin data-lang=kotlin style=background:#2b303b;color:#6c7079><code class=language-kotlin data-lang=kotlin><span style=color:#cd74e8>internal fun</span><span style=color:#abb2bf> Project.</span><span style=color:#5cb3fa>createAndroidJarAccessorExtension</span><span style=color:#abb2bf>() {
</span><span style=color:#abb2bf>    extensions</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>add(
</span><span style=color:#abb2bf>        </span><span style=font-style:italic;color:#5f697a>/* name = */ </span><span style=color:#9acc76>"androidJar"</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>        </span><span style=font-style:italic;color:#5f697a>/* extension = */</span><span style=color:#abb2bf> checkNotNull(rootProject</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>extensions</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>extraProperties[AndroidJarLocationKey]) {
</span><span style=color:#abb2bf>            </span><span style=color:#9acc76>"The property with 'android.jar' location is missing. Make sure the " </span><span style=color:#adb7c9>+
</span><span style=color:#abb2bf>                    </span><span style=color:#9acc76>"'jar.finder' plugin is applied in the root project"
</span><span style=color:#abb2bf>        }
</span><span style=color:#abb2bf>    )
</span><span style=color:#abb2bf>}
</span></code></pre><p>В convention-плагине Kotlin JVM модуля применяем:<pre class=language-kotlin data-lang=kotlin style=background:#2b303b;color:#6c7079><code class=language-kotlin data-lang=kotlin><span style=color:#cd74e8>class </span><span style=color:#f0c678>KotlinJvmConventionPlugin </span><span style=color:#adb7c9>: </span><span style=color:#9acc76>Plugin</span><span style=color:#abb2bf><</span><span style=color:#9acc76>Project</span><span style=color:#abb2bf>> {
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>override fun </span><span style=color:#5cb3fa>apply</span><span style=color:#abb2bf>(</span><span style=color:#adb7c9>target:</span><span style=color:#abb2bf> Project) {
</span><span style=color:#abb2bf>        </span><span style=color:#adb7c9>...
</span><span style=color:#abb2bf>        target</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>createAndroidJarAccessorExtension()
</span><span style=color:#abb2bf>    }
</span><span style=color:#abb2bf>}
</span></code></pre><p>Теперь прописывая в Kotlin JVM модулях зависимость <code>compileOnly(androidJar)</code> мы сможем использовать в них Context и другие андроидовские классы.<blockquote><p>Реализовать шаринг данных между корневым и дочерними проектами на этапе конфигурации можно разными способами. Возможно, в будущем текущий способ станет несовместимым с project isolation. Но к тому моменту у нас будет новое API для подобных целей.</blockquote><h3 id=izbavliaemsia-polnost-iu-zhestb-aar-to-jar>Избавляемся полностью жестб (aar-to-jar)<a aria-hidden=true class=anchor hidden href=#izbavliaemsia-polnost-iu-zhestb-aar-to-jar>#</a></h3><blockquote><p>Первоисточник: <a href=https://github.com/stepango/aar2jar>https://github.com/stepango/aar2jar</a></blockquote><p>По опыту могу сказать, что для большинства модулей в проекте подключения android jar не будет достаточно. Мы часто используем внешние библиотеки, которые можно подключить только к android-модулям.<p>Все дело в том что библиотеки под Android распространяются в виде AAR артефактов. JVM модули не знают о таких и позволяют подключать к себе только JAR библиотеки. Если мы <a href=https://developer.android.com/studio/projects/android-library#aar-contents>заглянем внутрь AAR</a>, то увидим что это ZIP архив внутри которого содержатся всякие андроидо-специфичные штуки и... JAR файлы с кодом.<h4 id=reshenie-na-russkom-iazyke>Решение на русском языке<a aria-hidden=true class=anchor hidden href=#reshenie-na-russkom-iazyke>#</a></h4><p>Чтобы наши pure kotlin/java модули научились понимать AAR зависимости, нам нужно всего лишь <del>старый советский</del> распаковать AAR, вытащить из него JAR файлы и подключить их в качестве зависимостей к нашему модулю. Звучит не сложно да?<h4 id=realizatsiia>Реализация<a aria-hidden=true class=anchor hidden href=#realizatsiia>#</a></h4><p>В Gradle есть встроенный механизм, позволяющий без большого количества костылей описать процесс трансформации зависимостей из одного формата в другой — Artifact Transform. У нее <a href=https://docs.gradle.org/current/userguide/artifact_transforms.html>есть непонятная дока</a> (как и любая дока по Gradle), но в нашем случае суть довольно проста:<blockquote><p><code>TransformAction</code> можно рассматривать как Task Action, но у которого есть ровно один input и один output. И этот Action предназначен только для конвертации одного артефакта в другой.<p>Когда какой-либо input у таски имеет "непонятный тип", Gradle попытается привести его к "понятному типу" путем применения нужных трансформаций.<p>Нам нужен такой <code>TransformAction</code>, который получив на вход AAR либу, выплюнет наружу ее JAR файлы</blockquote><p>Собсна <code>TransformAction</code> может выглядеть вот так:<pre class=language-kotlin data-lang=kotlin style=background:#2b303b;color:#6c7079><code class=language-kotlin data-lang=kotlin><span style=color:#cd74e8>abstract class </span><span style=color:#f0c678>Aar2JarTransformAction </span><span style=color:#adb7c9>: </span><span style=color:#9acc76>TransformAction</span><span style=color:#abb2bf><</span><span style=color:#9acc76>TransformParameters</span><span style=color:#abb2bf>.</span><span style=color:#9acc76>None</span><span style=color:#abb2bf>> {
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    @get</span><span style=color:#adb7c9>:</span><span style=color:#abb2bf>InputArtifact
</span><span style=color:#abb2bf>    @get</span><span style=color:#adb7c9>:</span><span style=color:#abb2bf>PathSensitive(PathSensitivity</span><span style=color:#adb7c9>.</span><span style=color:#db9d63>RELATIVE</span><span style=color:#abb2bf>)
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>abstract val </span><span style=color:#abb2bf>inputArtifact</span><span style=color:#adb7c9>:</span><span style=color:#abb2bf> Provider&LTFileSystemLocation>
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>override fun </span><span style=color:#5cb3fa>transform</span><span style=color:#abb2bf>(</span><span style=color:#adb7c9>outputs:</span><span style=color:#abb2bf> TransformOutputs) {
</span><span style=color:#abb2bf>        </span><span style=color:#cd74e8>val </span><span style=color:#abb2bf>inputFile </span><span style=color:#adb7c9>=</span><span style=color:#abb2bf> inputArtifact</span><span style=color:#adb7c9>.</span><span style=color:#5cb3fa>get</span><span style=color:#abb2bf>().asFile
</span><span style=color:#abb2bf>        </span><span style=color:#cd74e8>val </span><span style=color:#abb2bf>baseName </span><span style=color:#adb7c9>=</span><span style=color:#abb2bf> inputFile</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>nameWithoutExtension
</span><span style=color:#abb2bf>        ZipFile(inputFile)</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>use { zipFile </span><span style=color:#adb7c9>->
</span><span style=color:#abb2bf>            zipFile
</span><span style=color:#abb2bf>                </span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>entries()
</span><span style=color:#abb2bf>                </span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>toList()
</span><span style=color:#abb2bf>                </span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>filter { entry </span><span style=color:#adb7c9>-></span><span style=color:#abb2bf> entry</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>name</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>endsWith(</span><span style=color:#9acc76>".jar"</span><span style=color:#abb2bf>) }
</span><span style=color:#abb2bf>                </span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>forEach { entry </span><span style=color:#adb7c9>->
</span><span style=color:#abb2bf>                    </span><span style=color:#cd74e8>val </span><span style=color:#abb2bf>outputName </span><span style=color:#adb7c9>= </span><span style=color:#cd74e8>when</span><span style=color:#abb2bf> (entry</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>name) {
</span><span style=color:#abb2bf>                        </span><span style=color:#9acc76>"classes.jar" </span><span style=color:#adb7c9>-> </span><span style=color:#9acc76>"</span><span style=color:#eb6772>$baseName</span><span style=color:#9acc76>.jar"
</span><span style=color:#abb2bf>                        </span><span style=color:#cd74e8>else </span><span style=color:#adb7c9>-> </span><span style=color:#9acc76>"</span><span style=color:#eb6772>$baseName</span><span style=color:#9acc76>-</span><span style=color:#eb6772>${entry.name}</span><span style=color:#9acc76>"
</span><span style=color:#abb2bf>                    }
</span><span style=color:#abb2bf>                    outputs</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>file(outputName)</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>outputStream()</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>use { output </span><span style=color:#adb7c9>->
</span><span style=color:#abb2bf>                        zipFile</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>getInputStream(entry)</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>use { entryStream </span><span style=color:#adb7c9>->
</span><span style=color:#abb2bf>                            entryStream</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>copyTo(output)
</span><span style=color:#abb2bf>                        }
</span><span style=color:#abb2bf>                    }
</span><span style=color:#abb2bf>                }
</span><span style=color:#abb2bf>        }
</span><span style=color:#abb2bf>    }
</span><span style=color:#abb2bf>}
</span></code></pre><p>Эта версия немного отличается от оригинальной. Она умеет работать с AAR, в которые упаковано более одного <code>classes.jar</code>.<p>Ну и дальше в нашем Convention-плагине для Kotlin/Java JVM модулей мы должны зарегистрировать кастомный <code>TransformAction</code>, вызвав <code>configureAar2JarFeature</code>:<pre class=language-kotlin data-lang=kotlin style=background:#2b303b;color:#6c7079><code class=language-kotlin data-lang=kotlin><span style=color:#cd74e8>fun</span><span style=color:#abb2bf> Project.</span><span style=color:#5cb3fa>configureAar2JarFeature</span><span style=color:#abb2bf>() {
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>val </span><span style=color:#abb2bf>artifactTypeAttribute </span><span style=color:#adb7c9>=</span><span style=color:#abb2bf> ArtifactTypeDefinition</span><span style=color:#adb7c9>.</span><span style=color:#db9d63>ARTIFACT_TYPE_ATTRIBUTE
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    </span><span style=font-style:italic;color:#5f697a>// Регистрируем нашу трансформилку
</span><span style=color:#abb2bf>    dependencies</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>registerTransform(Aar2JarTransformAction</span><span style=color:#adb7c9>::</span><span style=color:#abb2bf>class</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>java) { spec </span><span style=color:#adb7c9>->
</span><span style=color:#abb2bf>        spec</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>from</span><span style=color:#adb7c9>.</span><span style=color:#cd74e8>attribute</span><span style=color:#abb2bf>(artifactTypeAttribute, </span><span style=color:#9acc76>"aar"</span><span style=color:#abb2bf>)
</span><span style=color:#abb2bf>        spec</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>to</span><span style=color:#adb7c9>.</span><span style=color:#cd74e8>attribute</span><span style=color:#abb2bf>(artifactTypeAttribute, </span><span style=color:#9acc76>"jar"</span><span style=color:#abb2bf>)
</span><span style=color:#abb2bf>    }
</span><span style=color:#abb2bf>}
</span></code></pre><blockquote><p>При регистрации указываем, что наша поделка трансформирует артефакты из AAR в JAR. Подробнее про атрибуты есть <a href=https://docs.gradle.org/current/userguide/variant_attributes.html>непонятная дока от Gradle</a>.</blockquote><h4 id=probuem-podkliuchit-aar-libu-cherez-compileonly>Пробуем подключить AAR либу через <code>compileOnly</code><a aria-hidden=true class=anchor hidden href=#probuem-podkliuchit-aar-libu-cherez-compileonly>#</a></h4><p>Чтобы протестировать, что наше решение НЕ РАБОТАЕТ, попробуем подключить к Kotlin модулю библиотеку Timber <del>(у нее AAR, брат)</del>. Подключим ее через конфигурацию <code>compileOnly</code>:<pre class=language-groovy data-lang=groovy style=background:#2b303b;color:#6c7079><code class=language-groovy data-lang=groovy><span style=color:#abb2bf>dependencies {
</span><span style=color:#abb2bf>    compileOnly(libs.timber)
</span><span style=color:#abb2bf>}
</span></code></pre><p>Во время синка будет ошибка вот такого рода:<p><img alt="Gradle Sucks V1" src=https://tonykolomeytsev.github.io/posts/esoteric-gradle-optimizations-reject-android-return-to-kotlin-jvm/gradle-sucks-v1.png><p>Я до конца так и не понял, как это обойти. Возможно в одном issue и кроется ответ: <a href=https://github.com/gradle/gradle/issues/8386>github.com/gradle/gradle/issues/8386</a>. Если выражаться на птичьем языке — какие-то из атрибутов конфигурации <code>compileOnly</code> несовместимы с подключаемыми AAR. А обойти это можно создав отдельную конфигурацию и вкинув ее содержимое в java compile classpath ручками. Пиздеееец.<h4 id=probuem-podkliuchit-aar-libu-cherez-aarcompileonly>Пробуем подключить AAR либу через <code>aarCompileOnly</code><a aria-hidden=true class=anchor hidden href=#probuem-podkliuchit-aar-libu-cherez-aarcompileonly>#</a></h4><p>Создаем конфигурацию с именем <code>aarCompileOnly</code>. будем с ее помощью подключать андроидовские библиотеки к Kotlin модулям. Дополняем функцию <code>configureAar2JarFeature</code>:<pre class=language-kotlin data-lang=kotlin style=background:#2b303b;color:#6c7079><code class=language-kotlin data-lang=kotlin><span style=color:#cd74e8>fun</span><span style=color:#abb2bf> Project.</span><span style=color:#5cb3fa>configureAar2JarFeature</span><span style=color:#abb2bf>() {
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>val </span><span style=color:#abb2bf>artifactTypeAttribute </span><span style=color:#adb7c9>=</span><span style=color:#abb2bf> ArtifactTypeDefinition</span><span style=color:#adb7c9>.</span><span style=color:#db9d63>ARTIFACT_TYPE_ATTRIBUTE
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    configurations</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>register(</span><span style=color:#9acc76>"aarCompileOnly"</span><span style=color:#abb2bf>) { aarCompileOnly </span><span style=color:#adb7c9>->
</span><span style=color:#abb2bf>        with(aarCompileOnly) {
</span><span style=color:#abb2bf>            isTransitive </span><span style=color:#adb7c9>= </span><span style=color:#db9d63>false </span><span style=font-style:italic;color:#5f697a>// не подсасываем транзитивные зависимости
</span><span style=color:#abb2bf>            isCanBeConsumed </span><span style=color:#adb7c9>= </span><span style=color:#db9d63>false
</span><span style=color:#abb2bf>            attributes</span><span style=color:#adb7c9>.</span><span style=color:#cd74e8>attribute</span><span style=color:#abb2bf>(artifactTypeAttribute, </span><span style=color:#9acc76>"jar"</span><span style=color:#abb2bf>)
</span><span style=color:#abb2bf>        }
</span><span style=color:#abb2bf>        plugins</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>withId(</span><span style=color:#9acc76>"java"</span><span style=color:#abb2bf>) {
</span><span style=color:#abb2bf>            javaExtension</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>sourceSets</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>named(</span><span style=color:#9acc76>"main"</span><span style=color:#abb2bf>) { main </span><span style=color:#adb7c9>->
</span><span style=color:#abb2bf>                main</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>compileClasspath </span><span style=color:#adb7c9>+=</span><span style=color:#abb2bf> aarCompileOnly
</span><span style=color:#abb2bf>            }
</span><span style=color:#abb2bf>        }
</span><span style=color:#abb2bf>    }
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    </span><span style=font-style:italic;color:#5f697a>// Регистрируем нашу трансформилку
</span><span style=color:#abb2bf>    </span><span style=color:#adb7c9>...
</span><span style=color:#abb2bf>}
</span><span style=color:#abb2bf>
</span><span style=color:#cd74e8>private val</span><span style=color:#abb2bf> Project.javaExtension</span><span style=color:#adb7c9>:</span><span style=color:#abb2bf> JavaPluginExtension
</span><span style=color:#abb2bf>    </span><span style=color:#5cb3fa>get</span><span style=color:#abb2bf>() </span><span style=color:#adb7c9>=</span><span style=color:#abb2bf> extensions</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>getByType(JavaPluginExtension</span><span style=color:#adb7c9>::</span><span style=color:#abb2bf>class</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>java)
</span></code></pre><p>Пробуем подключить Timber еще раз:<pre class=language-groovy data-lang=groovy style=background:#2b303b;color:#6c7079><code class=language-groovy data-lang=groovy><span style=color:#abb2bf>dependencies {
</span><span style=color:#abb2bf>    aarCompileOnly(libs.timber)
</span><span style=color:#abb2bf>}
</span></code></pre><p>И омагад, оно работает. Можно импортировать Timber в нашем Kotlin модуле, а потом это еще и без ошибок скомпилируется.<h4 id=dokruchivaem-reshenie>Докручиваем решение<a aria-hidden=true class=anchor hidden href=#dokruchivaem-reshenie>#</a></h4><p>Для того чтобы можно было подключать какие-то Android-библиотеки к Unit-тестам, нужна еще одна конфигурация: <code>aarTestImplementation</code>. Получается такой странный набор кастомных конфигураций, я объясню это в конце.<pre class=language-kotlin data-lang=kotlin style=background:#2b303b;color:#6c7079><code class=language-kotlin data-lang=kotlin><span style=color:#cd74e8>fun</span><span style=color:#abb2bf> Project.</span><span style=color:#5cb3fa>configureAar2JarFeature</span><span style=color:#abb2bf>() {
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>val </span><span style=color:#abb2bf>artifactTypeAttribute </span><span style=color:#adb7c9>=</span><span style=color:#abb2bf> ArtifactTypeDefinition</span><span style=color:#adb7c9>.</span><span style=color:#db9d63>ARTIFACT_TYPE_ATTRIBUTE
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    configurations</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>register(</span><span style=color:#9acc76>"aarCompileOnly"</span><span style=color:#abb2bf>) { </span><span style=color:#adb7c9>...</span><span style=color:#abb2bf> }
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    configurations</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>register(</span><span style=color:#9acc76>"aarTestImplementation"</span><span style=color:#abb2bf>) { aarTestImplementation </span><span style=color:#adb7c9>->
</span><span style=color:#abb2bf>        with(aarTestImplementation) {
</span><span style=color:#abb2bf>            isTransitive </span><span style=color:#adb7c9>= </span><span style=color:#db9d63>false
</span><span style=color:#abb2bf>            isCanBeConsumed </span><span style=color:#adb7c9>= </span><span style=color:#db9d63>false
</span><span style=color:#abb2bf>            attributes</span><span style=color:#adb7c9>.</span><span style=color:#cd74e8>attribute</span><span style=color:#abb2bf>(artifactTypeAttribute, </span><span style=color:#9acc76>"jar"</span><span style=color:#abb2bf>)
</span><span style=color:#abb2bf>        }
</span><span style=color:#abb2bf>        plugins</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>withId(</span><span style=color:#9acc76>"java"</span><span style=color:#abb2bf>) {
</span><span style=color:#abb2bf>            javaExtension</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>sourceSets</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>named(</span><span style=color:#9acc76>"test"</span><span style=color:#abb2bf>) { test </span><span style=color:#adb7c9>->
</span><span style=color:#abb2bf>                test</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>compileClasspath </span><span style=color:#adb7c9>+=</span><span style=color:#abb2bf> aarTestImplementation
</span><span style=color:#abb2bf>                test</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>runtimeClasspath </span><span style=color:#adb7c9>+=</span><span style=color:#abb2bf> aarTestImplementation
</span><span style=color:#abb2bf>            }
</span><span style=color:#abb2bf>        }
</span><span style=color:#abb2bf>    }
</span><span style=color:#abb2bf>}
</span></code></pre><p>И вишенкой на торте можно добавить фикс, нужный для корректной работы GUI Android Studio и IntelliJ IDEA с новыми конфигурациями:<pre class=language-kotlin data-lang=kotlin style=background:#2b303b;color:#6c7079><code class=language-kotlin data-lang=kotlin><span style=color:#cd74e8>internal fun</span><span style=color:#abb2bf> Project.</span><span style=color:#5cb3fa>configureAar2JarFeature</span><span style=color:#abb2bf>() {
</span><span style=color:#abb2bf>    </span><span style=color:#adb7c9>...
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    configurations</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>register(</span><span style=color:#9acc76>"aarCompileOnly"</span><span style=color:#abb2bf>) { aarCompileOnly </span><span style=color:#adb7c9>->
</span><span style=color:#abb2bf>        </span><span style=color:#adb7c9>...
</span><span style=color:#abb2bf>        </span><span style=font-style:italic;color:#5f697a>// Register configuration in IDEA if needed
</span><span style=color:#abb2bf>        plugins</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>withId(</span><span style=color:#9acc76>"idea"</span><span style=color:#abb2bf>) {
</span><span style=color:#abb2bf>            ideaExtension</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>module</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>scopes</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>forEach { (_, value) </span><span style=color:#adb7c9>->
</span><span style=color:#abb2bf>                value[</span><span style=color:#9acc76>"plus"</span><span style=color:#abb2bf>]</span><span style=color:#adb7c9>?.</span><span style=color:#abb2bf>add(aarCompileOnly)
</span><span style=color:#abb2bf>            }
</span><span style=color:#abb2bf>        }
</span><span style=color:#abb2bf>    }
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    configurations</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>register(</span><span style=color:#9acc76>"aarTestImplementation"</span><span style=color:#abb2bf>) { aarTestImplementation </span><span style=color:#adb7c9>->
</span><span style=color:#abb2bf>        </span><span style=color:#adb7c9>...
</span><span style=color:#abb2bf>        </span><span style=font-style:italic;color:#5f697a>// Register configuration in IDEA if needed
</span><span style=color:#abb2bf>        plugins</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>withId(</span><span style=color:#9acc76>"idea"</span><span style=color:#abb2bf>) {
</span><span style=color:#abb2bf>            ideaExtension</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>module</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>scopes[</span><span style=color:#9acc76>"TEST"</span><span style=color:#abb2bf>]
</span><span style=color:#abb2bf>                </span><span style=color:#adb7c9>?.</span><span style=color:#abb2bf>get(</span><span style=color:#9acc76>"plus"</span><span style=color:#abb2bf>)</span><span style=color:#adb7c9>?.</span><span style=color:#abb2bf>add(aarTestImplementation)
</span><span style=color:#abb2bf>        }
</span><span style=color:#abb2bf>    }
</span><span style=color:#abb2bf>}
</span><span style=color:#abb2bf>
</span><span style=color:#cd74e8>private val</span><span style=color:#abb2bf> Project.ideaExtension</span><span style=color:#adb7c9>:</span><span style=color:#abb2bf> IdeaModel
</span><span style=color:#abb2bf>    </span><span style=color:#5cb3fa>get</span><span style=color:#abb2bf>() </span><span style=color:#adb7c9>=</span><span style=color:#abb2bf> extensions</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>getByType(IdeaModel</span><span style=color:#adb7c9>::</span><span style=color:#abb2bf>class</span><span style=color:#adb7c9>.</span><span style=color:#abb2bf>java)
</span></code></pre><p>На этом все, пользуйтесь на здоровье. А теперь читаем про побочные эффекты этой черной магии.<h1 id=o-chem-stoit-pomnit>О чем стоит помнить<a aria-hidden=true class=anchor hidden href=#o-chem-stoit-pomnit>#</a></h1><h2 id=mozhet-upast-v-rantaime>Может упасть в рантайме<a aria-hidden=true class=anchor hidden href=#mozhet-upast-v-rantaime>#</a></h2><p>Библиотеки, добавленные через <code>aarCompileOnly</code> конфигурацию должны быть добавлены где-то еще в проекте через <code>runtimeOnly</code> или <code>implementation</code>. Например, в модуле <code>:app</code>.</p><center> <img src=pochemu-tak-nahui.png width=50%> </center><p>Все потому что, как я уже писал, если библиотека есть в compile classpath, но отсутствует в runtime classpath, она не поедет вместе с вашим приложением на прод. И при обращении к любому ее классу в рантайме будет <code>NoClassDefFoundError</code>.<blockquote><p>Так чисто на всякий случай пишу что <code>implementation(androidJar)</code> писать нигде не надо, потому что в рантайме он всегда есть и без вашей помощи.</blockquote><h2 id=strannyi-nabor-konfiguratsii>Странный набор конфигураций<a aria-hidden=true class=anchor hidden href=#strannyi-nabor-konfiguratsii>#</a></h2><p>AAR библиотеки как правило несут в себе иного другой полезной инфы, нужной для сборки Android приложения. Например, AndroidManifest и proguard файлы. Когда мы подключаем такую библиотеку через aar-to-jar трансформацию, мы все это успешно выбрасываем.<p>Поэтому я считаю что подключать AAR к jvm модулям нужно только через <code>aarCompileOnly</code>. Подключать только ради доступа к API. При этом в <code>:app</code> модуле подключать эти библиотеки через <code>implementation</code>.<p>Конфигурация <code>aarTestImplementation</code> подключает либу и в compile, и в runtime classpath. Это нужно для того чтобы Unit-тесты можно было запустить и чтоб они не падали из-за <code>NoClassDefFoundError</code>.<h2 id=pogibaet-android-lint>Погибает android lint<a aria-hidden=true class=anchor hidden href=#pogibaet-android-lint>#</a></h2><p>Мы теряем возможность использования Android Lint, отключая AGP от модуля. Хорошо что у нас есть Detekt.<h1 id=itogi>Итоги<a aria-hidden=true class=anchor hidden href=#itogi>#</a></h1><p>Избавление от AGP это один из самых эффективных способов снизить время конфигурации в большом проекте. И один из последних способов снизить билд-тайм, не внедряя impact-анализ.<p>Решение из этой заметки не новое, но я постарался хотя бы по верхам объяснить, за счет чего оно работает.</div><footer class=post-footer><ul class=post-tags><li><a href=https://tonykolomeytsev.github.io/tags/gradle/>gradle</a><li><a href=https://tonykolomeytsev.github.io/tags/gitlab/>gitlab</a><li><a href=https://tonykolomeytsev.github.io/tags/android/>android</a></ul><section class=comments><script async data-color=1d1e20 data-colorful=1 data-comments-limit=5 data-dark=1 data-dark-color=FFFFFF data-telegram-discussion=kekmech/46 id=tg-discussion-widget src=https://telegram.org/js/telegram-widget.js?22></script></section><nav class=paginav><a class=prev href=https://tonykolomeytsev.github.io/posts/free-and-effective-gitlab-caching-for-gradle/> <span class=title>« Prev</span> <br> <span>Gradle + GitLab: эффективный и бесплатный билд-кэш</span> </a></nav></footer></article></main><footer class=footer><span>© 2024 <a href=https://tonykolomeytsev.github.io>Anton Kolomeytsev</a></span><span> Powered by <a rel="noopener noreferrer" href=https://www.getzola.org/ target=_blank>Zola</a> & <a href=https://github.com/cydave/zola-theme-papermod rel=noopener target=_blank>PaperMod</a> </span></footer><a aria-label="go to top" title="Go to Top (Alt + G)" accesskey=g class=top-link href=#top id=top-link> <svg viewbox="0 0 12 6" fill=currentColor xmlns=http://www.w3.org/2000/svg><path d="M12 6H0l6-6z"/></svg> </a><script>let menu=document.getElementById('menu');if(menu){menu.scrollLeft=localStorage.getItem("menu-scroll-position");menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}};document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var c=this.getAttribute("href").substr(1);if(!window.matchMedia('(prefers-reduced-motion: reduce)').matches){document.querySelector(`[id='${decodeURIComponent(c)}']`).scrollIntoView({behavior:"smooth"})}else{document.querySelector(`[id='${decodeURIComponent(c)}']`).scrollIntoView()};if(c==="top"){history.replaceState(null,null," ")}else{history.pushState(null,null,`#${c}`)}})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){if(document.body.scrollTop>800||document.documentElement.scrollTop>800){mybutton.style.visibility="visible";mybutton.style.opacity="1"}else{mybutton.style.visibility="hidden";mybutton.style.opacity="0"}}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{if(document.body.className.includes("dark")){document.body.classList.remove('dark');localStorage.setItem("pref-theme",'light')}else{document.body.classList.add('dark');localStorage.setItem("pref-theme",'dark')}})</script><script>document.querySelectorAll('pre > code').forEach(a=>{const c=a.parentNode.parentNode;const d=document.createElement('button');d.classList.add('copy-code');d.innerText='copy';function b(){d.innerText='copied!';setTimeout(()=>{d.innerText='copy'},2000)}d.addEventListener('click',e=>{if('clipboard' in navigator){navigator.clipboard.writeText(a.textContent);b();return};const f=document.createRange();f.selectNodeContents(a);const g=window.getSelection();g.removeAllRanges();g.addRange(f);try{document.execCommand('copy');b()}catch(h){};g.removeRange(f)});if(c.classList.contains("highlight")){c.appendChild(d)}else if(c.parentNode.firstChild==c){}else if(a.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"){a.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(d)}else{a.parentNode.appendChild(d)}})</script>